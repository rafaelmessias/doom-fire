#include <stdlib.h>
#include "renderer.h"


unsigned char firePalette[37][3] = {
    0x07,0x07,0x07,
    0x1F,0x07,0x07,
    0x2F,0x0F,0x07,
    0x47,0x0F,0x07,
    0x57,0x17,0x07,
    0x67,0x1F,0x07,
    0x77,0x1F,0x07,
    0x8F,0x27,0x07,
    0x9F,0x2F,0x07,
    0xAF,0x3F,0x07,
    0xBF,0x47,0x07,
    0xC7,0x47,0x07,
    0xDF,0x4F,0x07,
    0xDF,0x57,0x07,
    0xDF,0x57,0x07,
    0xD7,0x5F,0x07,
    0xD7,0x5F,0x07,
    0xD7,0x67,0x0F,
    0xCF,0x6F,0x0F,
    0xCF,0x77,0x0F,
    0xCF,0x7F,0x0F,
    0xCF,0x87,0x17,
    0xC7,0x87,0x17,
    0xC7,0x8F,0x17,
    0xC7,0x97,0x1F,
    0xBF,0x9F,0x1F,
    0xBF,0x9F,0x1F,
    0xBF,0xA7,0x27,
    0xBF,0xA7,0x27,
    0xBF,0xAF,0x2F,
    0xB7,0xAF,0x2F,
    0xB7,0xB7,0x2F,
    0xB7,0xB7,0x37,
    0xCF,0xCF,0x6F,
    0xDF,0xDF,0x9F,
    0xEF,0xEF,0xC7,
    0xFF,0xFF,0xFF
};

int frameCount = 0;

void renderFrame()
{
    // Simulate 30fps
    if (frameCount % 2 == 0)
        for (int j = 0; j < WIDTH; ++j)
        {
            for (int i = HEIGHT - 2; i >= 0; --i)
            {
                if (pal_idx[i][j] == 0)
                {
                    pal_idx[i+1][j] = 0;
                }
                else
                {
                    int r = rand() % 3;
                    int from = j - r + 1;
                    pal_idx[i+1][from] =  pal_idx[i][j] - (r & 1);
                }                    
            }
        }
    frameCount++;
}


int main(int argc, char *argv[])
{
    initSystem();

    setPalette(firePalette, 37);

    for (int j = 0; j < WIDTH; ++j)
    {
        pal_idx[0][j] = 36;
    }

    startLoop(renderFrame);    
}